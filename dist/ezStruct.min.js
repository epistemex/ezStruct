/*
	ezStruct ver 0.3.0-alpha
	Copyright (c) 2018 Epistemex
	www.epistemex.com
*/
"use strict";var ezStruct=(function(){var a=[];return{enums:{UINT8:0,UBYTE:0,UINT:1,UINT16:1,USHORT:1,UINT32:2,ULONG:2,UINT64:3,ULONGLONG:3,INT8:4,BYTE:4,BOOL:4,SHORT:5,INT:5,INT16:5,INT32:6,LONG:6,INT64:7,LONGLONG:7,FLOAT32:8,FLOAT:8,FLOAT64:9,DOUBLE:9,BIT8:10,BIT16:11,CHAR:12,UCHAR:13,BYTES:13,STRING:14,STRUCT:15},define:function(c){var d={name:c,defs:[]},b;for(b=0;b<a.length;b++){if(a[b].name===c){throw"Structure with this name exists."}}a.push(d);return{name:c,def:function(k,g,h,j){if(k<0||k>ezStruct.TMPenums.STRUCT){throw"Invalid type."}for(var f=0,e=d.defs;f<e.length;f++){if(e[f].name===g){throw"Field already exists."}}e.push({name:g,type:k,opt:h,opt2:j})}}},alloc:function(O,P){P=Object.assign({le:!1,buffer:null,offset:0},P);var S,L,F,R=0,E=0,N={},T=[],G=[],K=!1,J=!1,M=P.le,q=(typeof O==="string")?O:O.name;for(L=0;L<a.length;L++){if(a[L].name===q){S=a[L];break}}if(!S){throw"Structure not defined."}S.defs.forEach(function(W){var ad=ezStruct.TMPenums;if((W.type!==ad.BIT8&&K)||(W.type!==ad.BIT16&&J)){R=H(R,K?1:2)}switch(W.type){case ad.UINT8:b(W.name,p,D,R,R+1);R++;break;case ad.UINT16:b(W.name,n,B,R,R+2);R+=2;break;case ad.UINT32:b(W.name,o,C,R,R+4);R+=4;break;case ad.INT8:b(W.name,j,y,R,R+1);R++;break;case ad.INT16:b(W.name,g,w,R,R+2);R+=2;break;case ad.INT32:b(W.name,h,x,R,R+4);R+=4;break;case ad.FLOAT32:b(W.name,e,u,R,R+4);R+=4;break;case ad.FLOAT64:b(W.name,f,v,R,R+8);R+=8;break;case ad.CHAR:case ad.UCHAR:b(W.name,m,A,R,W.opt);R+=W.opt;break;case ad.STRING:b(W.name,k,z,R,W.opt);R+=W.opt;break;case ad.STRUCT:var ac=ezStruct.alloc(W.opt,M);T.push({struct:ac,pos:R+P.offset,len:ac.uint8.length});Object.defineProperty(N,W.name,{get:l.bind({struct:ac})});R+=ac.uint8.length;break;case ad.BIT8:case ad.BIT16:var Z=W.type===ad.BIT8,ae=Z?8:16,V=E-(R<<3),ab=V%ae,aa=0,Y,U;if(Z){K=!0}else{J=!0}if(W.opt){if(W.name&&W.name.length){for(var X=V;X<V+W.opt;X++){aa|=1<<X}Y=~aa;U={m:N,pos:R,offset:ab,width:W.opt,mask:aa};Object.defineProperty(N,W.name,{get:(Z?d:c).bind(U),set:(Z?s:r).bind(U)})}E+=W.opt;if(V+W.opt>=ae){R=H(R,ae>>>3);E=R<<3}}else{R=H(R,ae>>>3);E=R<<3}break;default:throw"Unknown type."}if(W.type!==ad.BIT8&&W.type!==ad.BIT16){E=R<<3}if(W.type!==ad.STRUCT&&W.type!==ad.BIT8&&W.type!==ad.BIT16){I(W)}});if(K){R=H(R,1)}else{if(J){R=H(R,2)}}function H(U,i){K=J=!1;return U+i}function I(i){var U=(i.type===t.CHAR||i.type===t.STRING)?i.opt2:i.opt;if(typeof U!=="undefined"){G.push({name:i.name,value:U})}}F=P.buffer?P.buffer:new ArrayBuffer(R);if(F.byteLength<R){throw"Buffer too small."}N.buffer=F;N.offset=P.offset;N.view=new DataView(F,N.offset,R);N.uint8=new Uint8Array(F,N.offset,R);N.name=S.name;N.length=N.uint8.length;N.subs=T;N.hasDefaults=G.length>0;Q(T);function Q(i){i.forEach(function(W){var V=W.struct,U;if(V.hasDefaults){U=W.struct.uint8}V.offset+=W.pos;V.buffer=F;V.uint8=new Uint8Array(F,V.offset,W.len);V.view=new DataView(F,V.offset,W.len);if(V.hasDefaults){W.struct.uint8.set(U)}Q(V.subs)})}G.forEach(function(i){N[i.name]=i.value});function b(V,U,X,W,Y){Object.defineProperty(N,V,{get:U.bind(i(W,Y)),set:X.bind(i(W,Y))});function i(aa,Z){return{m:N,pos:aa,len:Z,le:!!M}}}function j(){return this.m.view.getInt8(this.pos)}function y(i){this.m.view.setInt8(this.pos,i)}function g(){return this.m.view.getInt16(this.pos,this.le)}function w(i){this.m.view.setInt16(this.pos,i,this.le)}function h(){return this.m.view.getInt32(this.pos,this.le)}function x(i){this.m.view.setInt32(this.pos,i,this.le)}function p(){return this.m.view.getUint8(this.pos)}function D(i){this.m.view.setUint8(this.pos,i)}function n(){return this.m.view.getUint16(this.pos,this.le)}function B(i){this.m.view.setUint16(this.pos,i,this.le)}function o(){return this.m.view.getUint32(this.pos,this.le)}function C(i){this.m.view.setUint32(this.pos,i,this.le)}function e(){return this.m.view.getFloat32(this.pos,this.le)}function u(i){this.m.view.setFloat32(this.pos,i,this.le)}function f(){return this.m.view.getFloat64(this.pos,this.le)}function v(i){this.m.view.setFloat64(this.pos,i,this.le)}function d(){return(this.m.uint8[this.pos]&this.mask)>>>this.offset}function s(i){this.m.uint8[this.pos]=this.m.uint8[this.pos]&~this.mask|((i<<this.offset)&this.mask)}function c(){return(this.m.view.getUint16(this.pos)&this.mask)>>>this.offset}function r(i){this.m.view.setUint16(this.pos,this.m.view.getUint16(this.pos)&~this.mask|((i<<this.offset)&this.mask))}function m(){return this.m.uint8.subarray(this.pos,this.len)}function A(i){if(i.length>this.len){throw"Illegal size."}this.m.uint8.set(i,this.pos)}function k(){var U=this.m.uint8.subarray(this.pos,this.pos+this.len),V=U.indexOf(0);return new TextDecoder().decode(V<0?U:U.subarray(0,V))}function z(U){var i=new TextEncoder().encode(U+"\0");if(i.length>this.len){throw"Illegal size."}this.m.uint8.set(i,this.pos)}function l(){return this.struct}return N},getDef:function(c){for(var b=0;b<a.length;b++){if(a[b].name===c){return a[b]}}return null},defFromC:function(c,b){},defToC:function(c){var d=typeof c==="string"?ezStruct.getDef(c):c,f,e=ezStruct.TMPenums;if(!d){throw"No definition with that name."}f="struct "+d.name+" {\n";d.defs.forEach(function(g){f+=b(g)});function b(g){var i=["unsigned char","unsigned int","unsigned long","unsigned long long","char","int","long","long long","float","double","unsigned char","unsigned int","char","unsigned char","char","struct"],h=i[g.type];return"   "+(h==="struct"?(typeof g.opt==="string"?g.opt:g.opt.name):h)+" "+(g.name||"")+(g.type===e.BIT8||g.type===e.BIT8?(g.name&&g.name.length?" : ":":")+g.opt:"")+(g.type===e.CHAR||g.type===e.STRING?"["+g.opt+"]":"")+(g.type<e.BIT8&&g.opt?" = "+g.opt:"")+(g.type>e.CHAR&&g.opt2?' = "'+g.opt2+'"':"")+";\n"}f+="};\n";return f},fromBuffer:function(e,b,c){var d=ezStruct.alloc(e,c);if(ArrayBuffer.isView(b)){b=b.buffer}d.uint8.set(new Uint8Array(b,0,Math.min(d.length,b.byteLength)));return d},clone:function(c){var b=ezStruct.alloc(c.name);b.uint8.set(c.uint8.slice(0,b.length));return b}}})();