/*
	ezStruct ver 0.3.2-alpha
	Copyright (c) 2018 Epistemex
	www.epistemex.com
*/
"use strict";var ezStruct=(function(){var a=[];return{enums:{UINT8:0,UBYTE:0,UINT:1,UINT16:1,USHORT:1,UINT32:2,ULONG:2,UINT64:3,ULONGLONG:3,INT8:4,BYTE:4,BOOL:4,SHORT:5,INT:5,INT16:5,INT32:6,LONG:6,INT64:7,LONGLONG:7,FLOAT32:8,FLOAT:8,FLOAT64:9,DOUBLE:9,BIT8:10,BIT16:11,CHAR:12,UCHAR:13,BYTES:13,STRING:14,STRUCT:15},define:function(c){var d={name:c,defs:[]},b;for(b=0;b<a.length;b++){if(a[b].name===c){throw"Structure with this name exists."}}a.push(d);return{name:c,def:function(k,g,h,j){if(k<0||k>ezStruct.TMPenums.STRUCT){throw"Invalid type."}for(var f=0,e=d.defs;f<e.length;f++){if(e[f].name===g){throw"Field already exists."}}e.push({name:g,type:k,opt:h,opt2:j})},sizeOf:function(){return ezStruct.alloc(d.name).length}}},alloc:function(M,N){N=Object.assign({le:!1,buffer:null,offset:0},N);var Q,E,P=0,D=0,L={},R=[],F=[],J=!1,I=!1,K=N.le,p=(typeof M==="string")?M:M.name;Q=ezStruct.getDef(p);if(!Q){throw"Unknown definition."}Q.defs.forEach(function(U){var aa=ezStruct.TMPenums;if((U.type!==aa.BIT8&&J)||(U.type!==aa.BIT16&&I)){P=G(P,J?1:2)}switch(U.type){case aa.UINT8:b(U.name,o,C,P,++P);break;case aa.UINT16:b(U.name,m,A,P,(P+=2));break;case aa.UINT32:b(U.name,n,B,P,(P+=4));break;case aa.INT8:b(U.name,i,x,P,++P);break;case aa.INT16:b(U.name,g,v,P,(P+=2));break;case aa.INT32:b(U.name,h,w,P,(P+=4));break;case aa.FLOAT32:b(U.name,e,s,P,(P+=4));break;case aa.FLOAT64:b(U.name,f,u,P,(P+=8));break;case aa.CHAR:case aa.UCHAR:b(U.name,l,z,P,U.opt);P+=U.opt;break;case aa.STRING:b(U.name,j,y,P,U.opt);P+=U.opt;break;case aa.STRUCT:var Z=ezStruct.alloc(U.opt,{le:K});R.push({struct:Z,pos:P+N.offset,len:Z.uint8.length});Object.defineProperty(L,U.name,{get:k.bind({struct:Z})});P+=Z.uint8.length;break;case aa.BIT8:J=!0;case aa.BIT16:var W=J,ab=W?8:16,T=D-(P<<3),Y=T%ab,X=0,S,V;if(W){J=!0}else{I=!0}if(U.opt){if(U.name&&U.name.length){for(V=T;V<T+U.opt;V++){X|=1<<V}S={m:L,pos:P,offset:Y,mask:X};Object.defineProperty(L,U.name,{get:(W?d:c).bind(S),set:(W?r:q).bind(S)})}D+=U.opt;if(T+U.opt>=ab){P=G(P,ab>>>3);D=P<<3}}else{P=G(P,ab>>>3);D=P<<3}break;default:throw"Unknown type."}if(U.type!==aa.BIT8&&U.type!==aa.BIT16){D=P<<3}if(U.type!==aa.STRUCT){H(U)}});if(J){P=G(P,1)}else{if(I){P=G(P,2)}}E=N.buffer?N.buffer:(N._rec?null:new ArrayBuffer(P));if(E.byteLength<P){throw"Buffer too small."}L.buffer=E;L.offset=N.offset|0;L.view=new DataView(E,L.offset,P);L.uint8=new Uint8Array(E,L.offset,P);L.name=Q.name;L.length=L.uint8.length;L._subs=R;L._dflt=F.length>0;O(R,0);F.forEach(function(S){L[S.name]=S.value});function O(T,S){T.forEach(function(W){var V=W.struct,U;if(V._dflt){U=W.struct.uint8}V.offset=S+W.pos;V.buffer=E;V.uint8=new Uint8Array(E,V.offset,W.len);V.view=new DataView(E,V.offset,W.len);if(V._dflt){W.struct.uint8.set(U)}O(V._subs,V.offset)})}function G(T,S){J=I=!1;return T+S}function H(S){var T=(S.type===t.CHAR||S.type===t.STRING||S.type===t.BIT8||S.type===t.BIT16)?S.opt2:S.opt;if(typeof T!=="undefined"){F.push({name:S.name,value:T})}}function b(U,T,W,V,X){Object.defineProperty(L,U,{get:T.bind(S(V,X)),set:W.bind(S(V,X))});function S(Z,Y){return{m:L,pos:Z,len:Y,le:!!K}}}function i(){return this.m.view.getInt8(this.pos)}function x(S){this.m.view.setInt8(this.pos,S)}function g(){return this.m.view.getInt16(this.pos,this.le)}function v(S){this.m.view.setInt16(this.pos,S,this.le)}function h(){return this.m.view.getInt32(this.pos,this.le)}function w(S){this.m.view.setInt32(this.pos,S,this.le)}function o(){return this.m.view.getUint8(this.pos)}function C(S){this.m.view.setUint8(this.pos,S)}function m(){return this.m.view.getUint16(this.pos,this.le)}function A(S){this.m.view.setUint16(this.pos,S,this.le)}function n(){return this.m.view.getUint32(this.pos,this.le)}function B(S){this.m.view.setUint32(this.pos,S,this.le)}function e(){return this.m.view.getFloat32(this.pos,this.le)}function s(S){this.m.view.setFloat32(this.pos,S,this.le)}function f(){return this.m.view.getFloat64(this.pos,this.le)}function u(S){this.m.view.setFloat64(this.pos,S,this.le)}function d(){return(this.m.uint8[this.pos]&this.mask)>>>this.offset}function r(S){this.m.uint8[this.pos]=this.m.uint8[this.pos]&~this.mask|((S<<this.offset)&this.mask)}function c(){return(this.m.view.getUint16(this.pos)&this.mask)>>>this.offset}function q(S){this.m.view.setUint16(this.pos,this.m.view.getUint16(this.pos)&~this.mask|((S<<this.offset)&this.mask))}function l(){return this.m.uint8.subarray(this.pos,this.len)}function z(S){if(S.length>this.len){throw"Illegal size."}this.m.uint8.set(S,this.pos)}function j(){var S=this.m.uint8.subarray(this.pos,this.pos+this.len),T=S.indexOf(0);return new TextDecoder().decode(T<0?S:S.subarray(0,T))}function y(T){var S=new TextEncoder().encode(T+"\0");if(S.length>this.len){throw"Illegal size."}this.m.uint8.set(S,this.pos)}function k(){return this.struct}return L},getDef:function(c){for(var b=0;b<a.length;b++){if(a[b].name===c){return a[b]}}return null},defFromC:function(c,b){},defToC:function(f){var g=typeof f==="string"?ezStruct.getDef(f):f,i,h=ezStruct.TMPenums,k="unsigned ",d="long",c="int",b="char",j=[k+b,k+c,k+d,k+d+" "+d,b,c,d,d+" "+d,"float","double",k+b,k+c,b,k+b,b,"struct"];if(!g){throw"Unknown definition."}i="struct "+g.name+" {\n";g.defs.forEach(function(l){i+=e(l)});function e(l){var m=j[l.type];return"   "+(m==="struct"?(typeof l.opt==="string"?l.opt:l.opt.name):m)+" "+(l.name||"")+(l.type===h.BIT8||l.type===h.BIT16?(l.name&&l.name.length?" : ":":")+l.opt:"")+(l.type===h.CHAR||l.type===h.STRING?"["+l.opt+"]":"")+(l.type<h.BIT8&&l.opt?" = "+l.opt:"")+(l.type>h.CHAR&&l.opt2?' = "'+l.opt2+'"':"")+";\n"}i+="};\n";return i},fromBuffer:function(e,b,c){var d=ezStruct.alloc(e,c);if(ArrayBuffer.isView(b)){b=b.buffer}d.uint8.set(new Uint8Array(b,0,Math.min(d.length,b.byteLength)));return d},clone:function(c){var b=ezStruct.alloc(c.name);b.uint8.set(c.uint8.slice(0));return b}}})();